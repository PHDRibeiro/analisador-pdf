<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultado da Análise</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-file-contract"></i> Resultado da Análise</h1>
      <p class="subtitle">Documentos encontrados e análise automatizada</p>
      
      {% if tipo_acao %}
      <div class="tipo-acao-banner">
        <div class="tipo-acao-info">
          <span class="tipo-acao-label">Tipo de Ação:</span>
          <span class="tipo-acao-valor">{{ tipo_acao }}</span>
          
          {% if data_distribuicao %}
          <span class="tipo-acao-label">Data de Distribuição:</span>
          <span class="tipo-acao-valor">{{ data_distribuicao }}</span>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </header>

    <div class="actions-bar">
      <a href="/" class="btn secondary"><i class="fas fa-arrow-left"></i> Voltar ao Início</a>
      <a href="/baixar_excel/{{ arquivo_excel }}" class="btn success"><i class="fas fa-file-excel"></i> Baixar Relatório Excel</a>
    </div>

    <div class="stats-summary">
      <div class="stat-card">
        <div class="stat-number">{{ resultados|length }}</div>
        <div class="stat-label">Total de autores</div>
      </div>
      
      <!-- Inicializa contadores -->
      {% set total_caf = namespace(value=0) %}
      {% set total_spprev = namespace(value=0) %}
      {% set total_extratao = namespace(value=0) %}
      
      <!-- Loop explícito com variáveis namespace para contagem -->
      {% for row in resultados %}
        {% for key, value in row.items() %}
          {% if 'informativo caf' in key|lower and value == 'Sim' %}
            {% set total_caf.value = total_caf.value + 1 %}
          {% endif %}
          
          {% if 'informativo spprev' in key|lower and value == 'Sim' %}
            {% set total_spprev.value = total_spprev.value + 1 %}
          {% endif %}
          
          {% if 'informativo extratão' in key|lower or 'informativo extratao' in key|lower %}
            {% if value == 'Sim' %}
              {% set total_extratao.value = total_extratao.value + 1 %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      
      <div class="stat-card">
        <div class="stat-number">{{ total_caf.value }}</div>
        <div class="stat-label">CAF</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-number">{{ total_spprev.value }}</div>
        <div class="stat-label">SPPREV</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-number">{{ total_extratao.value }}</div>
        <div class="stat-label">Extratão</div>
      </div>
    </div>

    <div class="card results-table-container">
      <h2><i class="fas fa-table"></i> Dados dos Autores</h2>
      
      <div class="filter-bar">
        <input type="text" id="filtro-nome" placeholder="Filtrar por nome..." class="filter-input">
        <select id="filtro-documentos" class="filter-select">
          <option value="todos">Todos os status</option>
          <option value="completo">Documentação completa</option>
          <option value="incompleto">Documentação incompleta</option>
        </select>
      </div>

      <div class="table-responsive">
        <table id="resultados-tabela">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>RG</th>
              <th>CPF</th>
              <th>CAF</th>
              <th>SPPREV</th>
              <th>Extratão</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for row in resultados %}
            <tr data-completo="{{ 'Sim' if 'informativo caf' in row and row['informativo caf'] == 'Sim' and 'informativo spprev' in row and row['informativo spprev'] == 'Sim' and 'informativo extratão' in row and row['informativo extratão'] == 'Sim' else 'Não' }}">
              <td>{{ row.get('id', row.get('Id', '')) }}</td>
              <td>{{ row.get('nome', row.get('Nome', '')) }}</td>
              <td>{{ row.get('rg', row.get('Rg', '')) }}</td>
              <td>{{ row.get('cpf', row.get('Cpf', '')) }}</td>
              
              <!-- CAF -->
              <td class="{{ 'status-sim' if row['Informativo CAF'] == 'Sim' else 'status-nao' }}">
                {{ row['Informativo CAF'] }}
                {% if row['Página CAF'] %}
                <span class="pagina-ref">Pág. {{ row['Página CAF'] }}</span>
                {% endif %}
              </td>

              <!-- SPPREV -->
              <td class="{{ 'status-sim' if row['Informativo SPPREV'] == 'Sim' else 'status-nao' }}">
                {{ row['Informativo SPPREV'] }}
                {% if row['Página SPPREV'] %}
                <span class="pagina-ref">Pág. {{ row['Página SPPREV'] }}</span>
                {% endif %}
              </td>

              <!-- Extratão -->
              <td class="{{ 'status-sim' if row['Informativo Extratão'] == 'Sim' else 'status-nao' }}">
                {{ row['Informativo Extratão'] }}
                {% if row['Página Extratão'] %}
                <span class="pagina-ref">Pág. {{ row['Página Extratão'] }}</span>
                {% endif %}
              </td>
              
              <td>
                <button class="btn-icon" onclick="mostrarAnalise({{ loop.index0 }})">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal para exibir análise detalhada -->
    <div id="analiseModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Análise Detalhada</h2>
        <div id="analise-detalhes" class="analise-detalhes"></div>
      </div>
    </div>
  </div>

  <footer>
    <p>Sistema de Análise de Processos &copy; 2025</p>
  </footer>

  <script>
// Armazena as análises para acesso rápido
const analises = [
  {% for row in resultados %}
    `{{ row['Análise']|replace("'", "\\'")|replace('"', '\\"')|replace('\n', '\\n') }}`,
  {% endfor %}
];

// Modal de análise
const modal = document.getElementById('analiseModal');
const closeBtn = document.getElementsByClassName('close-modal')[0];

function mostrarAnalise(index) {
  // Usa os dados diretamente do objeto resultados
  const autor = {{ resultados|tojson }}[index];
  
  document.getElementById('analise-detalhes').innerHTML = `
    <h3>${autor.Nome}</h3>
    <p class="analise-texto">${analises[index].replace(/\n/g, '<br>')}</p>
    <div class="autor-info">
      <div><strong>RG:</strong> ${autor.Rg}</div>
      <div><strong>CPF:</strong> ${autor.Cpf}</div>
    </div>
    <div class="docs-status">
      <div class="doc-item ${autor['Informativo CAF'] === 'Sim' ? 'doc-presente' : 'doc-ausente'}">
        <i class="fas ${autor['Informativo CAF'] === 'Sim' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
        <span>Informativo CAF</span>
        ${autor['Página CAF'] ? `<div class="pagina-info">Pág. ${autor['Página CAF']}</div>` : ''}
      </div>
      <div class="doc-item ${autor['Informativo SPPREV'] === 'Sim' ? 'doc-presente' : 'doc-ausente'}">
        <i class="fas ${autor['Informativo SPPREV'] === 'Sim' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
        <span>Informativo SPPREV</span>
        ${autor['Página SPPREV'] ? `<div class="pagina-info">Pág. ${autor['Página SPPREV']}</div>` : ''}
      </div>
      <div class="doc-item ${autor['Informativo Extratão'] === 'Sim' ? 'doc-presente' : 'doc-ausente'}">
        <i class="fas ${autor['Informativo Extratão'] === 'Sim' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
        <span>Informativo Extratão</span>
        ${autor['Página Extratão'] ? `<div class="pagina-info">Pág. ${autor['Página Extratão']}</div>` : ''}
      </div>
    </div>
  `;
  modal.style.display = 'block';
}

closeBtn.onclick = function() {
  modal.style.display = 'none';
}

window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = 'none';
  }
}

// Filtros da tabela
const filtroNome = document.getElementById('filtro-nome');
const filtroDocumentos = document.getElementById('filtro-documentos');
const tabela = document.getElementById('resultados-tabela');
const linhas = tabela.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

filtroNome.addEventListener('keyup', aplicarFiltros);
filtroDocumentos.addEventListener('change', aplicarFiltros);

function aplicarFiltros() {
  const textoBusca = filtroNome.value.toLowerCase();
  const statusFiltro = filtroDocumentos.value;
  
  for (let i = 0; i < linhas.length; i++) {
    const linha = linhas[i];
    const nome = linha.getElementsByTagName('td')[1].textContent.toLowerCase();
    const completo = linha.getAttribute('data-completo');
    
    let exibirLinha = nome.includes(textoBusca);
    
    if (statusFiltro === 'completo' && completo !== 'Sim') {
      exibirLinha = false;
    } else if (statusFiltro === 'incompleto' && completo !== 'Não') {
      exibirLinha = false;
    }
    
    linha.style.display = exibirLinha ? '' : 'none';
  }
}
  </script>
</body>
</html>